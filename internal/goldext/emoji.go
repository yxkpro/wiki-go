package goldext

import (
	"strings"
)

// EmojiPreprocessor replaces emoji shortcodes with Unicode emoji characters
// but avoids processing text inside code blocks
func EmojiPreprocessor(markdown string, _ string) string {
	// Process line by line instead of relying on regex which might fail on large documents
	lines := strings.Split(markdown, "\n")
	var result []string

	inCodeBlock := false

	// Define emoji mappings
	// Data from https://gist.github.com/rxaviers/7360908
	emojis := map[string]string{
		":grinning:":                       "ğŸ˜€",
		":smiley:":                         "ğŸ˜ƒ",
		":smile:":                          "ğŸ˜„",
		":grin:":                           "ğŸ˜",
		":laughing:":                       "ğŸ˜†",
		":satisfied:":                      "ğŸ˜†",
		":sweat_smile:":                    "ğŸ˜…",
		":rofl:":                           "ğŸ¤£",
		":joy:":                            "ğŸ˜‚",
		":slightly_smiling_face:":          "ğŸ™‚",
		":upside_down_face:":               "ğŸ™ƒ",
		":wink:":                           "ğŸ˜‰",
		":blush:":                          "ğŸ˜Š",
		":innocent:":                       "ğŸ˜‡",
		":smiling_face_with_three_hearts:": "ğŸ¥°",
		":heart_eyes:":                     "ğŸ˜",
		":star_struck:":                    "ğŸ¤©",
		":kissing_heart:":                  "ğŸ˜˜",
		":kissing:":                        "ğŸ˜—",
		":relaxed:":                        "â˜ºï¸",
		":kissing_closed_eyes:":            "ğŸ˜š",
		":kissing_smiling_eyes:":           "ğŸ˜™",
		":yum:":                            "ğŸ˜‹",
		":stuck_out_tongue:":               "ğŸ˜›",
		":stuck_out_tongue_winking_eye:":   "ğŸ˜œ",
		":zany_face:":                      "ğŸ¤ª",
		":stuck_out_tongue_closed_eyes:":   "ğŸ˜",
		":money_mouth_face:":               "ğŸ¤‘",
		":hugs:":                           "ğŸ¤—",
		":hand_over_mouth:":                "ğŸ¤­",
		":shushing_face:":                  "ğŸ¤«",
		":thinking:":                       "ğŸ¤”",
		":zipper_mouth_face:":              "ğŸ¤",
		":raised_eyebrow:":                 "ğŸ¤¨",
		":neutral_face:":                   "ğŸ˜",
		":expressionless:":                 "ğŸ˜‘",
		":no_mouth:":                       "ğŸ˜¶",
		":smirk:":                          "ğŸ˜",
		":unamused:":                       "ğŸ˜’",
		":roll_eyes:":                      "ğŸ™„",
		":grimacing:":                      "ğŸ˜¬",
		":lying_face:":                     "ğŸ¤¥",
		":relieved:":                       "ğŸ˜Œ",
		":pensive:":                        "ğŸ˜”",
		":sleepy:":                         "ğŸ˜ª",
		":drooling_face:":                  "ğŸ¤¤",
		":sleeping:":                       "ğŸ˜´",
		":mask:":                           "ğŸ˜·",
		":face_with_thermometer:":          "ğŸ¤’",
		":face_with_head_bandage:":         "ğŸ¤•",
		":nauseated_face:":                 "ğŸ¤¢",
		":vomiting_face:":                  "ğŸ¤®",
		":sneezing_face:":                  "ğŸ¤§",
		":hot_face:":                       "ğŸ¥µ",
		":cold_face:":                      "ğŸ¥¶",
		":woozy_face:":                     "ğŸ¥´",
		":dizzy_face:":                     "ğŸ˜µ",
		":exploding_head:":                 "ğŸ¤¯",
		":cowboy_hat_face:":                "ğŸ¤ ",
		":partying_face:":                  "ğŸ¥³",
		":sunglasses:":                     "ğŸ˜",
		":nerd_face:":                      "ğŸ¤“",
		":monocle_face:":                   "ğŸ§",
		":confused:":                       "ğŸ˜•",
		":worried:":                        "ğŸ˜Ÿ",
		":slightly_frowning_face:":         "ğŸ™",
		":frowning_face:":                  "â˜¹ï¸",
		":open_mouth:":                     "ğŸ˜®",
		":hushed:":                         "ğŸ˜¯",
		":astonished:":                     "ğŸ˜²",
		":flushed:":                        "ğŸ˜³",
		":pleading_face:":                  "ğŸ¥º",
		":frowning:":                       "ğŸ˜¦",
		":anguished:":                      "ğŸ˜§",
		":fearful:":                        "ğŸ˜¨",
		":cold_sweat:":                     "ğŸ˜°",
		":disappointed_relieved:":          "ğŸ˜¥",
		":cry:":                            "ğŸ˜¢",
		":sob:":                            "ğŸ˜­",
		":scream:":                         "ğŸ˜±",
		":confounded:":                     "ğŸ˜–",
		":persevere:":                      "ğŸ˜£",
		":disappointed:":                   "ğŸ˜",
		":sweat:":                          "ğŸ˜“",
		":weary:":                          "ğŸ˜©",
		":tired_face:":                     "ğŸ˜«",
		":yawning_face:":                   "ğŸ¥±",
		":triumph:":                        "ğŸ˜¤",
		":rage:":                           "ğŸ˜¡",
		":pout:":                           "ğŸ˜¡",
		":angry:":                          "ğŸ˜ ",
		":cursing_face:":                   "ğŸ¤¬",
		":smiling_imp:":                    "ğŸ˜ˆ",
		":imp:":                            "ğŸ‘¿",
		":skull:":                          "ğŸ’€",
		":skull_and_crossbones:":           "â˜ ï¸",
		":clown_face:":                     "ğŸ¤¡",
		":ghost:":                          "ğŸ‘»",
		":alien:":                          "ğŸ‘½",
		":yellow_heart:":                   "ğŸ’›",
		":blue_heart:":                     "ğŸ’™",
		":purple_heart:":                   "ğŸ’œ",
		":heart:":                          "â¤ï¸",
		":green_heart:":                    "ğŸ’š",
		":broken_heart:":                   "ğŸ’”",
		":heartbeat:":                      "ğŸ’“",
		":heartpulse:":                     "ğŸ’—",
		":two_hearts:":                     "ğŸ’•",
		":revolving_hearts:":               "ğŸ’",
		":cupid:":                          "ğŸ’˜",
		":sparkling_heart:":                "ğŸ’–",
		":sparkles:":                       "âœ¨",
		":star:":                           "â­",
		":star2:":                          "ğŸŒŸ",
		":dizzy:":                          "ğŸ’«",
		":boom:":                           "ğŸ’¥",
		":collision:":                      "ğŸ’¥",
		":anger:":                          "ğŸ’¢",
		":exclamation:":                    "â—",
		":question:":                       "â“",
		":grey_exclamation:":               "â•",
		":grey_question:":                  "â”",
		":zzz:":                            "ğŸ’¤",
		":dash:":                           "ğŸ’¨",
		":sweat_drops:":                    "ğŸ’¦",
		":notes:":                          "ğŸ¶",
		":musical_note:":                   "ğŸµ",
		":fire:":                           "ğŸ”¥",
		":hankey:":                         "ğŸ’©",
		":poop:":                           "ğŸ’©",
		":shit:":                           "ğŸ’©",
		":+1:":                             "ğŸ‘",
		":thumbsup:":                       "ğŸ‘",
		":-1:":                             "ğŸ‘",
		":thumbsdown:":                     "ğŸ‘",
		":ok_hand:":                        "ğŸ‘Œ",
		":punch:":                          "ğŸ‘Š",
		":facepunch:":                      "ğŸ‘Š",
		":fist:":                           "âœŠ",
		":v:":                              "âœŒï¸",
		":wave:":                           "ğŸ‘‹",
		":hand:":                           "âœ‹",
		":raised_hand:":                    "âœ‹",
		":open_hands:":                     "ğŸ‘",
		":point_up:":                       "â˜ï¸",
		":point_down:":                     "ğŸ‘‡",
		":point_left:":                     "ğŸ‘ˆ",
		":point_right:":                    "ğŸ‘‰",
		":raised_hands:":                   "ğŸ™Œ",
		":pray:":                           "ğŸ™",
		":point_up_2:":                     "ğŸ‘†",
		":clap:":                           "ğŸ‘",
		":muscle:":                         "ğŸ’ª",
		":metal:":                          "ğŸ¤˜",
		":fu:":                             "ğŸ–•",
		":smiley_cat:":                     "ğŸ˜º",
		":smile_cat:":                      "ğŸ˜¸",
		":heart_eyes_cat:":                 "ğŸ˜»",
		":kissing_cat:":                    "ğŸ˜½",
		":smirk_cat:":                      "ğŸ˜¼",
		":scream_cat:":                     "ğŸ™€",
		":crying_cat_face:":                "ğŸ˜¿",
		":joy_cat:":                        "ğŸ˜¹",
		":pouting_cat:":                    "ğŸ˜¾",
		":feet:":                           "ğŸ‘£",
		":lips:":                           "ğŸ‘„",
		":kiss:":                           "ğŸ’‹",
		":droplet:":                        "ğŸ’§",
		":ear:":                            "ğŸ‘‚",
		":eyes:":                           "ğŸ‘€",
		":nose:":                           "ğŸ‘ƒ",
		":tongue:":                         "ğŸ‘…",
		":love_letter:":                    "ğŸ’Œ",
		":bust_in_silhouette:":             "ğŸ‘¤",
		":busts_in_silhouette:":            "ğŸ‘¥",
		":speech_balloon:":                 "ğŸ’¬",
		":thought_balloon:":                "ğŸ’­",
		":anger_right:":                    "ğŸ—¯ï¸",
		":sunny:":                          "â˜€ï¸",
		":umbrella:":                       "â˜”",
		":cloud:":                          "â˜ï¸",
		":snowflake:":                      "â„ï¸",
		":snowman:":                        "â›„",
		":zap:":                            "âš¡",
		":cyclone:":                        "ğŸŒ€",
		":foggy:":                          "ğŸŒ",
		":ocean:":                          "ğŸŒŠ",
		":cat:":                            "ğŸ±",
		":dog:":                            "ğŸ¶",
		":mouse:":                          "ğŸ­",
		":hamster:":                        "ğŸ¹",
		":rabbit:":                         "ğŸ°",
		":wolf:":                           "ğŸº",
		":frog:":                           "ğŸ¸",
		":tiger:":                          "ğŸ¯",
		":koala:":                          "ğŸ¨",
		":bear:":                           "ğŸ»",
		":pig:":                            "ğŸ·",
		":pig_nose:":                       "ğŸ½",
		":cow:":                            "ğŸ®",
		":boar:":                           "ğŸ—",
		":monkey_face:":                    "ğŸµ",
		":monkey:":                         "ğŸ’",
		":horse:":                          "ğŸ´",
		":racehorse:":                      "ğŸ",
		":camel:":                          "ğŸ«",
		":sheep:":                          "ğŸ‘",
		":elephant:":                       "ğŸ˜",
		":panda_face:":                     "ğŸ¼",
		":snake:":                          "ğŸ",
		":bird:":                           "ğŸ¦",
		":baby_chick:":                     "ğŸ¤",
		":hatched_chick:":                  "ğŸ¥",
		":hatching_chick:":                 "ğŸ£",
		":chicken:":                        "ğŸ”",
		":penguin:":                        "ğŸ§",
		":turtle:":                         "ğŸ¢",
		":bug:":                            "ğŸ›",
		":honeybee:":                       "ğŸ",
		":beetle:":                         "ğŸ",
		":snail:":                          "ğŸŒ",
		":octopus:":                        "ğŸ™",
		":tropical_fish:":                  "ğŸ ",
		":fish:":                           "ğŸŸ",
		":whale:":                          "ğŸ³",
		":whale2:":                         "ğŸ‹",
		":dolphin:":                        "ğŸ¬",
		":cow2:":                           "ğŸ„",
		":ram:":                            "ğŸ",
		":rat:":                            "ğŸ€",
		":water_buffalo:":                  "ğŸƒ",
		":tiger2:":                         "ğŸ…",
		":rabbit2:":                        "ğŸ‡",
		":dragon:":                         "ğŸ‰",
		":goat:":                           "ğŸ",
		":rooster:":                        "ğŸ“",
		":dog2:":                           "ğŸ•",
		":pig2:":                           "ğŸ–",
		":mouse2:":                         "ğŸ",
		":ox:":                             "ğŸ‚",
		":dragon_face:":                    "ğŸ²",
		":blowfish:":                       "ğŸ¡",
		":crocodile:":                      "ğŸŠ",
		":dromedary_camel:":                "ğŸª",
		":leopard:":                        "ğŸ†",
		":cat2:":                           "ğŸˆ",
		":poodle:":                         "ğŸ©",
		":hammer:":                         "ğŸ”¨",
		":axe:":                            "ğŸª“",
		":hammer_and_wrench:":              "ğŸ› ï¸",
		":bomb:":                           "ğŸ’£",
		":shield:":                         "ğŸ›¡ï¸",
		":wrench:":                         "ğŸ”§",
		":gear:":                           "âš™ï¸",
		":100:":                            "ğŸ’¯",
		":1234:":                           "ğŸ”¢",
		":8ball:":                          "ğŸ±",
		":a:":                              "ğŸ…°ï¸",
		":ab:":                             "ğŸ†",
		":abc:":                            "ğŸ”¤",
		":abcd:":                           "ğŸ”¡",
		":accept:":                         "ğŸ‰‘",
		":aerial_tramway:":                 "ğŸš¡",
		":airplane:":                       "âœˆï¸",
		":alarm_clock:":                    "â°",
		":ambulance:":                      "ğŸš‘",
		":anchor:":                         "âš“",
		":apple:":                          "ğŸ",
		":aquarius:":                       "â™’",
		":aries:":                          "â™ˆ",
		":arrow_backward:":                 "â—€ï¸",
		":arrow_double_down:":              "â¬",
		":arrow_double_up:":                "â«",
		":arrow_down:":                     "â¬‡ï¸",
		":arrow_down_small:":               "ğŸ”½",
		":arrow_forward:":                  "â–¶ï¸",
		":arrow_heading_down:":             "â¤µï¸",
		":arrow_heading_up:":               "â¤´ï¸",
		":arrow_left:":                     "â¬…ï¸",
		":arrow_lower_left:":               "â†™ï¸",
		":arrow_lower_right:":              "â†˜ï¸",
		":arrow_right:":                    "â¡ï¸",
		":arrow_right_hook:":               "â†ªï¸",
		":arrow_up:":                       "â¬†ï¸",
		":arrow_up_down:":                  "â†•ï¸",
		":arrow_up_small:":                 "ğŸ”¼",
		":arrow_upper_left:":               "â†–ï¸",
		":arrow_upper_right:":              "â†—ï¸",
		":arrows_clockwise:":               "ğŸ”ƒ",
		":arrows_counterclockwise:":        "ğŸ”„",
		":art:":                            "ğŸ¨",
		":articulated_lorry:":              "ğŸš›",
		":x:":                              "âŒ",
		":heavy_check_mark:":               "âœ”ï¸",
		":heavy_multiplication_x:":         "âœ–ï¸",
		":heavy_plus_sign:":                "â•",
		":heavy_minus_sign:":               "â–",
		":heavy_division_sign:":            "â—",
		":computer:":                       "ğŸ’»",
		":keyboard:":                       "âŒ¨ï¸",
		":mouse3:":                         "ğŸ–±ï¸",
		":trackball:":                      "ğŸ–²ï¸",
		":joystick:":                       "ğŸ•¹ï¸",
		":gamepad:":                        "ğŸ®",
		":one:":                            "1ï¸âƒ£",
		":two:":                            "2ï¸âƒ£",
		":three:":                          "3ï¸âƒ£",
		":four:":                           "4ï¸âƒ£",
		":five:":                           "5ï¸âƒ£",
		":six:":                            "6ï¸âƒ£",
		":seven:":                          "7ï¸âƒ£",
		":eight:":                          "8ï¸âƒ£",
		":nine:":                           "9ï¸âƒ£",
		":zero:":                           "0ï¸âƒ£",
		":hash:":                           "#ï¸âƒ£",
		":ballot_box_with_check:":          "â˜‘ï¸",
		":white_check_mark:":               "âœ…",
		":green_square:":                   "ğŸŸ©",
		":blue_square:":                    "ğŸŸ¦",
		":shipit:":                         "ğŸš¢",
	}

	for _, line := range lines {
		// Check if this line starts or ends a code block
		trimmedLine := strings.TrimSpace(line)
		if strings.HasPrefix(trimmedLine, "```") || strings.HasPrefix(trimmedLine, "~~~") {
			inCodeBlock = !inCodeBlock
			result = append(result, line)
			continue
		}

		// If we're in a code block, don't process
		if inCodeBlock {
			result = append(result, line)
			continue
		}

		// Process each segment of the line, preserving inline code
		var processedLine string
		segments := strings.Split(line, "`")

		for i, segment := range segments {
			// Even segments (0, 2, 4...) are outside inline code
			if i%2 == 0 {
				// Apply all replacements to non-code segments
				for shortcode, emoji := range emojis {
					segment = strings.ReplaceAll(segment, shortcode, emoji)
				}
				processedLine += segment
			} else {
				// Odd segments (1, 3, 5...) are inside inline code - preserve them
				processedLine += "`" + segment + "`"
			}
		}

		result = append(result, processedLine)
	}

	return strings.Join(result, "\n")
}
